name: CI

on:
 push:
  branches:
   - '**'
 pull_request:
  branches:
   - '**'

jobs:
 full-suite:
  strategy:
   fail-fast: false
   matrix:
    os: [ubuntu-latest, windows-latest, macos-latest]
  runs-on: ${{ matrix.os }}
  steps:
   - name: Checkout
     uses: actions/checkout@v4

   - name: Setup Bun
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: 1.2.21

   - name: Force HTTPS for GitHub git dependencies
     run: |
      git config --global url."https://github.com/".insteadOf "git@github.com:"
      git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"

   - name: Install dependencies
     run: bun install --frozen-lockfile

   - name: Main Validation Gate
     run: |
      bun run typecheck
      bun run lint
      bun run check:boundaries
      bun run check:release:readiness
      bun run test
      bun run test:provider
      bun run check:migrations
      bun run test:migration
      bun run test:integration:stable
      bun run test:smoke

 packaging-smoke:
  runs-on: ubuntu-latest
  steps:
   - name: Checkout
     uses: actions/checkout@v4

   - name: Setup Bun
     uses: oven-sh/setup-bun@v2
     with:
      bun-version: 1.2.21

   - name: Force HTTPS for GitHub git dependencies
     run: |
      git config --global url."https://github.com/".insteadOf "git@github.com:"
      git config --global url."https://github.com/".insteadOf "ssh://git@github.com/"

   - name: Install dependencies
     run: bun install --frozen-lockfile

   - name: Linux package smoke test
     run: bun run make -- --platform=linux
